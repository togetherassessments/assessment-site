import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// ES module equivalent of __dirname
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Get environment variables
const WEBSITE_ID = process.env.WEBSITE_ID;
const ASSESSMENTS_URL = process.env.ASSESSMENTS_URL;
const ADHD_URL = process.env.ADHD_URL;
const AUTISM_URL = process.env.AUTISM_URL;

// Validate required environment variables
if (!WEBSITE_ID) {
  console.error('‚ùå ERROR: WEBSITE_ID environment variable is required');
  console.error('   Use: WEBSITE_ID=assessments npm run dev:assessments');
  process.exit(1);
}

if (!ASSESSMENTS_URL || !ADHD_URL || !AUTISM_URL) {
  console.error('‚ùå ERROR: Site URL environment variables are required');
  console.error(
    '   Missing:',
    [!ASSESSMENTS_URL && 'ASSESSMENTS_URL', !ADHD_URL && 'ADHD_URL', !AUTISM_URL && 'AUTISM_URL']
      .filter(Boolean)
      .join(', ')
  );
  console.error('');
  console.error('   For local development:');
  console.error('   npm run dev:assessments (URLs set automatically)');
  console.error('');
  console.error('   For production builds:');
  console.error('   Set environment variables in Netlify dashboard or netlify.toml');
  console.error('   OR pass them explicitly:');
  console.error('   ASSESSMENTS_URL=https://... npm run build:assessments');
  process.exit(1);
}

if (!['assessments', 'adhd', 'autism'].includes(WEBSITE_ID)) {
  console.error(`‚ùå ERROR: Invalid WEBSITE_ID "${WEBSITE_ID}"`);
  console.error('   Must be: assessments, adhd, or autism');
  process.exit(1);
}

// Site configuration
const siteConfig = {
  assessments: {
    mediaFolder: 'src/assets/images/assessments',
    publicFolder: '~/assets/images/assessments',
    url: ASSESSMENTS_URL,
  },
  adhd: {
    mediaFolder: 'src/assets/images/adhd',
    publicFolder: '~/assets/images/adhd',
    url: ADHD_URL,
  },
  autism: {
    mediaFolder: 'src/assets/images/autism',
    publicFolder: '~/assets/images/autism',
    url: AUTISM_URL,
  },
};

const config = siteConfig[WEBSITE_ID];

// Detect if we're in local development (localhost URLs) or production
const isLocalDev = config.url.includes('localhost');

// Read template
console.log(`\nüîß Generating CMS config for: ${WEBSITE_ID}`);
console.log(`   URL: ${config.url}`);
console.log(`   Environment: ${isLocalDev ? 'Local Development' : 'Production'}`);
console.log(`   Media: ${config.mediaFolder}\n`);

const templatePath = path.join(__dirname, '../public/admin/config.template.yml');
let template = fs.readFileSync(templatePath, 'utf8');

// Strip out the template header (everything before "backend:")
const backendIndex = template.indexOf('backend:');
if (backendIndex === -1) {
  console.error('‚ùå ERROR: Could not find "backend:" in template file');
  process.exit(1);
}
const templateBody = template.substring(backendIndex);

// Create auto-generated warning header
const generationTime = new Date().toISOString();
const autoGeneratedHeader = `# ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è AUTO-GENERATED FILE - DO NOT EDIT ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
#
# Generated from: public/admin/config.template.yml
# Generated for: ${WEBSITE_ID}
# Generated at: ${generationTime}
#
# To modify CMS configuration, edit public/admin/config.template.yml
#
# ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ALL CHANGES TO THIS FILE WILL BE OVERWRITTEN ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

`;

// Replace placeholders in template body
let processedConfig = templateBody.replace(/\{\{WEBSITE_ID\}\}/g, WEBSITE_ID);
processedConfig = processedConfig.replace(/\{\{MEDIA_FOLDER\}\}/g, config.mediaFolder);
processedConfig = processedConfig.replace(/\{\{PUBLIC_FOLDER\}\}/g, config.publicFolder);
processedConfig = processedConfig.replace(/\{\{SITE_URL\}\}/g, config.url);
processedConfig = processedConfig.replace(/\{\{LOCAL_BACKEND\}\}/g, isLocalDev ? 'true' : 'false');

// Combine header + processed config
const finalConfig = autoGeneratedHeader + processedConfig;

// Write to public/admin/config.yml
const configPath = path.join(__dirname, '../public/admin/config.yml');
fs.writeFileSync(configPath, finalConfig, 'utf8');

console.log(`‚úÖ CMS config generated: public/admin/config.yml\n`);
