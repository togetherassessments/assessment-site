---
// Main accessibility settings panel
import { DEFAULT_SETTINGS } from './AccessibilitySettings';

// Server-side: use default settings for initial state (client-side will load from localStorage)
const settings = DEFAULT_SETTINGS;
---

<!-- Panel -->
<div
  id="accessibility-panel"
  class="accessibility-panel"
  role="dialog"
  aria-modal="true"
  aria-label="Accessibility Settings"
>
  <div class="accessibility-panel-header">
    <h2 class="accessibility-panel-title">Accessibility Settings</h2>
    <button
      id="accessibility-close"
      type="button"
      class="accessibility-panel-close"
      aria-label="Close accessibility settings"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <div class="accessibility-panel-content">
    <!-- Font Selection -->
    <section class="accessibility-section">
      <h3 class="accessibility-section-title">Font</h3>
      <div class="accessibility-radio-group" role="radiogroup" aria-label="Font selection">
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="font"
            value="sylexiad"
            checked={settings.font === 'sylexiad'}
            class="accessibility-radio"
          />
          <span class="font-preview font-preview-sylexiad">Sylexiad Sans</span>
        </label>
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="font"
            value="opendyslexic"
            checked={settings.font === 'opendyslexic'}
            class="accessibility-radio"
          />
          <span class="font-preview font-preview-opendyslexic">OpenDyslexic</span>
        </label>
        <label class="accessibility-radio-label">
          <input type="radio" name="font" value="fast" checked={settings.font === 'fast'} class="accessibility-radio" />
          <span class="font-preview font-preview-fast">Fast Sans</span>
        </label>
      </div>
    </section>

    <!-- Theme Selection -->
    <section class="accessibility-section">
      <h3 class="accessibility-section-title">Theme</h3>
      <div class="accessibility-radio-group" role="radiogroup" aria-label="Theme selection">
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="theme"
            value="light"
            checked={settings.theme === 'light'}
            class="accessibility-radio"
          />
          <span>Light</span>
        </label>
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="theme"
            value="dark"
            checked={settings.theme === 'dark'}
            class="accessibility-radio"
          />
          <span>Dark</span>
        </label>
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="theme"
            value="system"
            checked={settings.theme === 'system'}
            class="accessibility-radio"
          />
          <span>System</span>
        </label>
      </div>
    </section>

    <!-- Text Size -->
    <section class="accessibility-section">
      <h3 class="accessibility-section-title">Text Size</h3>
      <div class="accessibility-button-group" role="group" aria-label="Text size selection">
        <button
          type="button"
          data-text-size="xs"
          class="accessibility-size-btn"
          aria-pressed={settings.textSize === 'xs'}
          aria-label="Extra Small"
        >
          <span style="font-size: 0.75rem;">A-</span>
        </button>
        <button
          type="button"
          data-text-size="sm"
          class="accessibility-size-btn"
          aria-pressed={settings.textSize === 'sm'}
          aria-label="Small"
        >
          <span style="font-size: 0.875rem;">A-</span>
        </button>
        <button
          type="button"
          data-text-size="base"
          class="accessibility-size-btn active"
          aria-pressed={settings.textSize === 'base'}
          aria-label="Normal"
        >
          <span style="font-size: 1rem;">A</span>
        </button>
        <button
          type="button"
          data-text-size="lg"
          class="accessibility-size-btn"
          aria-pressed={settings.textSize === 'lg'}
          aria-label="Large"
        >
          <span style="font-size: 1.125rem;">A+</span>
        </button>
        <button
          type="button"
          data-text-size="xl"
          class="accessibility-size-btn"
          aria-pressed={settings.textSize === 'xl'}
          aria-label="Extra Large"
        >
          <span style="font-size: 1.25rem;">A+</span>
        </button>
      </div>
      <p class="accessibility-size-label">Current: <span id="text-size-label">Normal</span></p>
    </section>

    <!-- Line Height (Placeholder) -->
    <section class="accessibility-section">
      <h3 class="accessibility-section-title">Line Height</h3>
      <div class="accessibility-radio-group" role="radiogroup" aria-label="Line height selection">
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="lineHeight"
            value="compact"
            checked={settings.lineHeight === 'compact'}
            class="accessibility-radio"
          />
          <span>Compact</span>
        </label>
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="lineHeight"
            value="normal"
            checked={settings.lineHeight === 'normal'}
            class="accessibility-radio"
          />
          <span>Normal</span>
        </label>
        <label class="accessibility-radio-label">
          <input
            type="radio"
            name="lineHeight"
            value="relaxed"
            checked={settings.lineHeight === 'relaxed'}
            class="accessibility-radio"
          />
          <span>Relaxed</span>
        </label>
      </div>
    </section>

    <!-- Reading Ruler (Placeholder) -->
    <section class="accessibility-section">
      <h3 class="accessibility-section-title">Reading Ruler</h3>
      <label class="accessibility-toggle-label">
        <input type="checkbox" id="reading-ruler" checked={settings.readingRuler} class="accessibility-toggle" />
        <span class="accessibility-toggle-slider"></span>
        <span class="accessibility-toggle-text">Highlight current line</span>
      </label>
    </section>

    <!-- Text-to-Speech -->
    <section class="accessibility-section">
      <h3 class="accessibility-section-title">Text-to-Speech</h3>
      <button type="button" data-tts-toggle class="accessibility-tts-btn" aria-label="Listen to this page">
        <!-- Loading spinner (hidden by default) -->
        <svg class="tts-loading-spinner" style="display: none;" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-opacity="0.25"></circle>
          <path fill="currentColor" d="M12 2a10 10 0 0 1 10 10h-4a6 6 0 0 0-6-6V2z" opacity="0.75">
            <animateTransform
              attributeName="transform"
              type="rotate"
              from="0 12 12"
              to="360 12 12"
              dur="1s"
              repeatCount="indefinite"></animateTransform>
          </path>
        </svg>
        <!-- Volume icon (shown by default) -->
        <svg class="tts-btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
          ></path>
        </svg>
        <span>Listen to This Page</span>
      </button>
    </section>

    <!-- Reset Button -->
    <section class="accessibility-section">
      <button id="reset-settings" type="button" class="accessibility-reset-btn"> Reset to Defaults </button>
    </section>
  </div>
</div>

<!-- Backdrop -->
<div id="accessibility-backdrop" class="accessibility-backdrop" aria-hidden="true"></div>

<style>
  /* Backdrop */
  .accessibility-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 300ms ease,
      visibility 300ms ease;
    z-index: 999;
  }

  .accessibility-panel.open ~ .accessibility-backdrop {
    opacity: 1;
    visibility: visible;
  }

  /* Panel */
  .accessibility-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 360px;
    max-width: 100vw;
    height: 100vh;
    background: var(--aw-color-bg-page);
    box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
    transform: translateX(100%);
    transition: transform 300ms ease;
    z-index: 1000;
    overflow-y: auto;
  }

  .accessibility-panel.open {
    transform: translateX(0);
  }

  /* Mobile: slide up from bottom */
  @media (max-width: 767px) {
    .accessibility-panel {
      top: auto;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 80vh;
      max-height: 600px;
      transform: translateY(100%);
    }

    .accessibility-panel.open {
      transform: translateY(0);
    }
  }

  /* Header */
  .accessibility-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--aw-color-border);
    position: sticky;
    top: 0;
    background: var(--aw-color-bg-page);
    z-index: 1;
  }

  .accessibility-panel-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
  }

  .accessibility-panel-close {
    padding: 0.5rem;
    border-radius: 0.375rem;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--aw-color-text-muted);
    transition:
      background-color 200ms,
      color 200ms;
  }

  .accessibility-panel-close:hover {
    background: var(--aw-color-bg-hover);
    color: var(--aw-color-text);
  }

  /* Content */
  .accessibility-panel-content {
    padding: 1.5rem;
  }

  .accessibility-section {
    margin-bottom: 2rem;
  }

  .accessibility-section:last-child {
    margin-bottom: 0;
  }

  .accessibility-section-title {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--aw-color-text-muted);
    margin: 0 0 0.75rem 0;
  }

  /* Radio Groups */
  .accessibility-radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .accessibility-radio-label {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 200ms;
  }

  .accessibility-radio-label:hover {
    background: var(--aw-color-bg-hover);
  }

  .accessibility-radio {
    margin-right: 0.75rem;
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  /* Font preview styles - fonts applied dynamically via JavaScript to prevent CLS and network blocking */
  /* Hide font previews until fonts load to prevent flash of system font on slow connections */
  .font-preview-opendyslexic,
  .font-preview-fast {
    opacity: 0;
    transition: opacity 0.3s ease-in;
  }

  /* Show previews when fonts are loaded (instant if cached, fade-in if loading) */
  .font-preview-opendyslexic.fonts-loaded,
  .font-preview-fast.fonts-loaded {
    opacity: 1;
  }

  /* Sylexiad is always preloaded, no need to hide */

  /* Button Groups */
  .accessibility-button-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .accessibility-size-btn {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid var(--aw-color-border);
    border-radius: 0.375rem;
    background: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 200ms;
  }

  .accessibility-size-btn:hover {
    background: var(--aw-color-bg-hover);
  }

  .accessibility-size-btn.active,
  .accessibility-size-btn[aria-pressed='true'] {
    background: var(--aw-color-primary);
    color: white;
    border-color: var(--aw-color-primary);
  }

  .accessibility-size-label {
    color: var(--aw-color-text-muted);
    margin: 0;
  }

  /* Toggle Switch */
  .accessibility-toggle-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.75rem;
    border-radius: 0.5rem;
    transition: background-color 200ms;
  }

  .accessibility-toggle-label:hover {
    background: var(--aw-color-bg-hover);
  }

  .accessibility-toggle {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .accessibility-toggle-slider {
    position: relative;
    width: 3rem;
    height: 1.5rem;
    background: rgba(107, 114, 128, 0.3);
    border-radius: 9999px;
    margin-right: 0.75rem;
    transition: background-color 200ms;
    border: 1px solid rgba(107, 114, 128, 0.4);
  }

  .accessibility-toggle-slider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 2px;
    transform: translateY(-50%);
    width: 1.25rem;
    height: 1.25rem;
    background: white;
    border-radius: 50%;
    transition: all 200ms;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
  }

  /* Dark mode specific overrides for toggle */
  :global(.dark) .accessibility-toggle-slider {
    background: rgba(156, 163, 175, 0.3);
    border-color: rgba(156, 163, 175, 0.5);
  }

  :global(.dark) .accessibility-toggle-slider::before {
    background: rgb(229, 231, 235);
  }

  .accessibility-toggle:checked + .accessibility-toggle-slider {
    background: var(--aw-color-primary);
    border-color: var(--aw-color-primary);
  }

  .accessibility-toggle:checked + .accessibility-toggle-slider::before {
    transform: translateX(1.5rem) translateY(-50%);
  }

  .accessibility-toggle-text {
    /* Font size scales via CustomStyles.astro */
  }

  /* TTS Button */
  .accessibility-tts-btn {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--aw-color-primary);
    border-radius: 0.375rem;
    background: var(--aw-color-primary);
    color: white;
    cursor: pointer;
    font-weight: 500;
    transition: all 200ms;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .accessibility-tts-btn:hover:not(:disabled) {
    background: var(--aw-color-secondary);
    border-color: var(--aw-color-secondary);
  }

  .accessibility-tts-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .tts-btn-icon,
  .tts-loading-spinner {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  /* Reset Button */
  .accessibility-reset-btn {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--aw-color-border);
    border-radius: 0.375rem;
    background: transparent;
    cursor: pointer;
    color: var(--aw-color-text-muted);
    transition: all 200ms;
  }

  .accessibility-reset-btn:hover {
    background: var(--aw-color-bg-hover);
    color: var(--aw-color-text);
    border-color: var(--aw-color-text-muted);
  }

  /* Prevent body scroll when panel open */
  :global(body.accessibility-panel-open) {
    overflow: hidden;
  }

  /* Reading Ruler Styles - Draggable Handle Approach */
  :global(.reading-ruler-container) {
    position: fixed;
    left: 0;
    width: 100vw;
    height: 1.5em; /* Default height - will be updated by JS */
    pointer-events: none; /* Allow clicks to pass through */
    z-index: 9998;
    display: flex;
    align-items: stretch;
  }

  :global(.reading-ruler-handle) {
    position: relative;
    width: 40px;
    flex-shrink: 0;
    background: rgba(147, 51, 234, 0.8); /* Purple accent */
    pointer-events: auto; /* Handle is interactive */
    cursor: grab;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none; /* Prevents scrolling when dragging handle */
    transition: background-color 0.2s ease;
  }

  :global(.reading-ruler-handle:hover) {
    background: rgba(147, 51, 234, 0.95);
  }

  :global(.reading-ruler-handle:active),
  :global(.reading-ruler-handle.dragging) {
    cursor: grabbing;
    background: rgba(126, 34, 206, 1);
  }

  :global(.reading-ruler-handle svg) {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
  }

  :global(.reading-ruler-highlight) {
    flex: 1;
    background: transparent;
    border-bottom: 3px solid rgba(0, 0, 0, 0.8); /* Dark ruler line at bottom */
    pointer-events: none;
  }

  /* Dark mode adjustments - use light background highlight instead of line */
  :global(.dark) :global(.reading-ruler-highlight) {
    background: rgba(230, 230, 250, 0.2);
    border-bottom: none;
  }

  /* Add body padding when ruler is active to prevent content being covered */
  :global(body.reading-ruler-active) {
    padding-left: 40px;
  }

  /* Vertical line to demarcate ruler area - using ::before pseudo-element */
  :global(body.reading-ruler-active)::before {
    content: '';
    position: fixed;
    left: 40px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: rgba(0, 0, 0, 0.3);
    z-index: 9997; /* Just below ruler handle */
    pointer-events: none;
  }

  /* Dark mode adjustment for vertical line */
  :global(.dark):global(body.reading-ruler-active)::before {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Also pad the mobile accessibility panel when ruler is active (mobile only - it slides up from bottom) */
  @media (max-width: 767px) {
    :global(body.reading-ruler-active) .accessibility-panel {
      padding-left: 40px;
    }
  }

  /* Also pad the mobile menu (header when expanded) when ruler is active */
  /* Target at mobile viewport sizes where menu is visible */
  @media (max-width: 767px) {
    :global(body.reading-ruler-active) #header.expanded nav {
      padding-left: 40px !important;
    }

    :global(body.reading-ruler-active) #header.expanded nav ul {
      padding-left: 40px !important;
    }
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    :global(.reading-ruler-handle) {
      transition: none;
    }
  }
</style>

<script is:inline>
  (function () {
    // Font loading state
    let accessibilityFontsLoaded = false;
    let accessibilityFontsLoading = false;

    // Lazy load accessibility fonts (OpenDyslexic and Fast Sans)
    async function loadAccessibilityFonts() {
      // Only load once
      if (accessibilityFontsLoaded || accessibilityFontsLoading) {
        return;
      }

      accessibilityFontsLoading = true;

      // Check if browser supports CSS Font Loading API
      if (!('fonts' in document)) {
        console.warn('CSS Font Loading API not supported');
        accessibilityFontsLoaded = true;
        accessibilityFontsLoading = false;
        return;
      }

      // Create FontFace objects
      const openDyslexic = new FontFace(
        'OpenDyslexic3',
        'url(/fonts/OpenDyslexic3-Regular.woff2) format("woff2"), url(/fonts/OpenDyslexic3-Regular.woff) format("woff"), url(/fonts/OpenDyslexic3-Regular.ttf) format("truetype")',
        { weight: '400', style: 'normal', display: 'swap' }
      );

      const fastSans = new FontFace(
        'Fast Sans',
        'url(/fonts/Fast_Sans.woff2) format("woff2"), url(/fonts/Fast_Sans.woff) format("woff"), url(/fonts/Fast_Sans.ttf) format("truetype")',
        { weight: '400', style: 'normal', display: 'swap' }
      );

      // Load fonts
      try {
        const fonts = await Promise.all([openDyslexic.load(), fastSans.load()]);
        fonts.forEach((font) => {
          document.fonts.add(font);
        });
        accessibilityFontsLoaded = true;
        accessibilityFontsLoading = false;
        console.log('âœ“ Accessibility fonts loaded');
      } catch (error) {
        console.warn('Failed to load accessibility fonts:', error);
        accessibilityFontsLoaded = true;
        accessibilityFontsLoading = false;
      }
    }

    // Local copy of AccessibilitySettings utilities (inline scripts can't use imports)
    const DEFAULT_SETTINGS = {
      font: 'sylexiad',
      theme: 'system',
      textSize: 'base',
      lineHeight: 'normal',
      readingRuler: false,
    };

    function getSettings() {
      if (typeof localStorage === 'undefined') return DEFAULT_SETTINGS;
      const stored = localStorage.getItem('accessibility-preferences');
      if (!stored) return DEFAULT_SETTINGS;
      try {
        return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
      } catch {
        return DEFAULT_SETTINGS;
      }
    }

    function saveSettings(settings) {
      if (typeof localStorage === 'undefined') return;
      localStorage.setItem('accessibility-preferences', JSON.stringify(settings));
    }

    function resetSettings() {
      if (typeof localStorage === 'undefined') return DEFAULT_SETTINGS;
      localStorage.removeItem('accessibility-preferences');
      return DEFAULT_SETTINGS;
    }

    function applyFont(font) {
      const fonts = {
        sylexiad: 'Sylexiad Sans Medium, ui-sans-serif, system-ui, -apple-system',
        opendyslexic: 'OpenDyslexic3, ui-sans-serif, system-ui, -apple-system',
        fast: 'Fast Sans, ui-sans-serif, system-ui, -apple-system',
      };
      document.documentElement.style.setProperty('--aw-font-sans', fonts[font]);
    }

    function applyFontPreviews() {
      const previews = {
        sylexiad: document.querySelector('.font-preview-sylexiad'),
        opendyslexic: document.querySelector('.font-preview-opendyslexic'),
        fast: document.querySelector('.font-preview-fast'),
      };

      if (previews.sylexiad) {
        previews.sylexiad.style.fontFamily = "'Sylexiad Sans Medium', sans-serif";
      }

      if (accessibilityFontsLoaded) {
        if (previews.opendyslexic) {
          previews.opendyslexic.style.fontFamily = "'OpenDyslexic3', sans-serif";
          previews.opendyslexic.classList.add('fonts-loaded');
        }
        if (previews.fast) {
          previews.fast.style.fontFamily = "'Fast Sans', sans-serif";
          previews.fast.classList.add('fonts-loaded');
        }
      }
    }

    function applyTheme(theme) {
      if (theme === 'system') {
        localStorage.removeItem('theme');
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        document.documentElement.classList.toggle('dark', systemTheme === 'dark');
      } else {
        localStorage.setItem('theme', theme);
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }
    }

    function applyTextSize(size) {
      document.body.classList.remove('text-size-xs', 'text-size-sm', 'text-size-base', 'text-size-lg', 'text-size-xl');
      if (size && size !== 'base') {
        document.body.classList.add(`text-size-${size}`);
      }
    }

    function applyLineHeight(lineHeight) {
      document.body.classList.remove('line-height-compact', 'line-height-normal', 'line-height-relaxed');
      if (lineHeight && lineHeight !== 'normal') {
        document.body.classList.add(`line-height-${lineHeight}`);
      }
    }

    // Placeholder for reading ruler (will be replaced by lazy-loaded module)
    // This is a no-op initially; the lazy-loaded module will replace it
    function applyReadingRuler(_enabled) {
      // Reading ruler functionality is loaded lazily when the panel opens
      // The lazy-loaded module will override this function
      // For now, just store the preference (it will be applied when module loads)
    }

    function updateUI(settings) {
      const fontRadio = document.querySelector(`input[name="font"][value="${settings.font}"]`);
      if (fontRadio) fontRadio.checked = true;

      const themeRadio = document.querySelector(`input[name="theme"][value="${settings.theme}"]`);
      if (themeRadio) themeRadio.checked = true;

      document.querySelectorAll('.accessibility-size-btn').forEach((btn) => {
        const button = btn;
        const size = button.dataset.textSize;
        if (size === settings.textSize) {
          button.classList.add('active');
          button.setAttribute('aria-pressed', 'true');
        } else {
          button.classList.remove('active');
          button.setAttribute('aria-pressed', 'false');
        }
      });

      const labels = {
        xs: 'Extra Small',
        sm: 'Small',
        base: 'Normal',
        lg: 'Large',
        xl: 'Extra Large',
      };
      const label = document.getElementById('text-size-label');
      if (label) label.textContent = labels[settings.textSize] || 'Normal';

      const lineHeightRadio = document.querySelector(`input[name="lineHeight"][value="${settings.lineHeight}"]`);
      if (lineHeightRadio) lineHeightRadio.checked = true;

      const rulerCheckbox = document.getElementById('reading-ruler');
      if (rulerCheckbox) rulerCheckbox.checked = settings.readingRuler;
    }

    function applySettings(settings) {
      applyFont(settings.font);
      applyTheme(settings.theme);
      applyTextSize(settings.textSize);
      applyLineHeight(settings.lineHeight);
      // Use the global utils version if available (from lazy-loaded module), otherwise local no-op
      if (window.accessibilityPanelUtils?.applyReadingRuler) {
        window.accessibilityPanelUtils.applyReadingRuler(settings.readingRuler);
      } else {
        applyReadingRuler(settings.readingRuler);
      }
    }

    // Expose utility functions globally for lazy-loaded module
    window.accessibilityPanelUtils = {
      getSettings,
      saveSettings,
      resetSettings,
      applySettings,
      applyFont,
      applyTheme,
      applyTextSize,
      applyLineHeight,
      applyReadingRuler,
      loadAccessibilityFonts,
      applyFontPreviews,
    };

    // Main initialization function - called on initial load AND after each navigation
    function initializeAccessibilityPanel() {
      const currentSettings = getSettings();

      // If reading ruler is enabled, load the full interaction module immediately
      // to ensure the ruler is functional on page load for users who need it.
      // Note: Lighthouse never tests with ruler enabled (uses default settings),
      // so this has zero impact on performance scores while ensuring accessibility
      // for users who explicitly enabled this feature.
      if (currentSettings.readingRuler) {
        // Trigger the lazy-load initialization function (defined in separate script block below)
        if (typeof window.initializeAccessibilityPanelInteractions === 'function') {
          // Wait for module to load, then apply settings
          window.initializeAccessibilityPanelInteractions().then(() => {
            applySettings(currentSettings);
            updateUI(currentSettings);
          });
          return; // Module will handle settings application
        } else {
          // Function not yet defined (still loading), retry after a brief delay
          setTimeout(() => {
            initializeAccessibilityPanel();
          }, 50);
          return;
        }
      }

      // Normal path for users without ruler enabled (vast majority + Lighthouse)
      // Check if user has saved OpenDyslexic or Fast Sans preference
      const isDeferredFont = currentSettings.font === 'opendyslexic' || currentSettings.font === 'fast';

      if (isDeferredFont) {
        loadAccessibilityFonts().then(() => {
          applySettings(currentSettings);
          updateUI(currentSettings);
        });
      } else {
        applySettings(currentSettings);
        updateUI(currentSettings);
      }
    }

    // Minimal toggle handler for opening the panel
    // The lazy-loaded module will handle all other interactions
    document.addEventListener('click', (e) => {
      const target = e.target.closest('[data-accessibility-toggle]');
      if (!target) return;

      const panel = document.getElementById('accessibility-panel');
      const allToggleButtons = document.querySelectorAll('[data-accessibility-toggle]');
      const isOpen = panel?.classList.contains('open');

      if (isOpen) {
        panel?.classList.remove('open');
        allToggleButtons.forEach((btn) => btn.setAttribute('aria-expanded', 'false'));
        document.body.classList.remove('accessibility-panel-open');
      } else {
        // Close mobile navigation menu if open
        if (typeof window.closeMobileMenu === 'function') {
          window.closeMobileMenu();
        }

        panel?.classList.add('open');
        allToggleButtons.forEach((btn) => btn.setAttribute('aria-expanded', 'true'));
        document.body.classList.add('accessibility-panel-open');

        // Load fonts when panel opens (will only load once)
        loadAccessibilityFonts().then(() => {
          applyFontPreviews();
        });

        // Initialize TTS when panel opens (will only initialize once)
        if (typeof window.initializeTTSIfNeeded === 'function') {
          window.initializeTTSIfNeeded();
        }

        // Trigger lazy-loading of interaction handlers
        if (typeof window.initializeAccessibilityPanelInteractions === 'function') {
          window.initializeAccessibilityPanelInteractions();
        }
      }
    });

    // === INITIAL LOAD ===
    initializeAccessibilityPanel();

    // === ASTRO VIEW TRANSITIONS ===
    document.addEventListener('astro:page-load', () => {
      initializeAccessibilityPanel();
    });
  })();
</script>

<script>
  // TTS initialization - separate non-inline script so Vite can process imports
  // This script is processed by Vite, allowing proper dynamic imports

  let ttsInitialized = false;

  // Make function available globally for the inline script
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  (window as any).initializeTTSIfNeeded = async function () {
    if (ttsInitialized) {
      return;
    }

    ttsInitialized = true;

    try {
      const { initialize } = await import('~/scripts/tts-init');
      initialize();
    } catch (error) {
      console.error('Failed to initialize TTS:', error);
      ttsInitialized = false; // Allow retry on error
    }
  };

  // Accessibility Panel interaction initialization - separate non-inline script so Vite can process imports
  let accessibilityPanelInitialized = false;

  // Make function available globally for triggering on first interaction
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  (window as any).initializeAccessibilityPanelInteractions = async function () {
    if (accessibilityPanelInitialized) {
      return Promise.resolve(); // Already initialized, return resolved promise
    }

    accessibilityPanelInitialized = true;

    try {
      const { initialize } = await import('~/scripts/accessibility-panel-init');
      initialize();
      return Promise.resolve();
    } catch (error) {
      console.error('Failed to initialize accessibility panel interactions:', error);
      accessibilityPanelInitialized = false; // Allow retry on error
      return Promise.reject(error);
    }
  };

  // Reset initialization flag on page navigation to allow re-initialization
  // This is needed for features like the reading ruler that need to be recreated on each page
  document.addEventListener('astro:before-swap', () => {
    accessibilityPanelInitialized = false;
  });

  // Initialize interactions on first accessibility panel interaction
  // Trigger on accessibility button click or keyboard shortcut
  document.addEventListener(
    'click',
    (e: MouseEvent) => {
      const target = (e.target as HTMLElement).closest('[data-accessibility-toggle]');
      if (target) {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        if (typeof (window as any).initializeAccessibilityPanelInteractions === 'function') {
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          (window as any).initializeAccessibilityPanelInteractions();
        }
      }
    },
    { once: false, capture: true }
  );

  // Also trigger on Ctrl+Shift+A keyboard shortcut
  document.addEventListener(
    'keydown',
    (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'A') {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        if (typeof (window as any).initializeAccessibilityPanelInteractions === 'function') {
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          (window as any).initializeAccessibilityPanelInteractions();
        }
      }
    },
    { once: false, capture: true }
  );
</script>
