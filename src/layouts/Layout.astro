---
import '~/assets/styles/tailwind.css';

import { I18N } from 'astrowind:config';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';
import StructuredData from '~/components/common/StructuredData.astro';

// Comment the line below to disable View Transitions
import { ClientRouter } from 'astro:transitions';

import type { MetaData as MetaDataType } from '~/types';
import { getSiteSettings } from '~/utils/site-settings';

export interface Props {
  metadata?: MetaDataType;
}

const { metadata = {} } = Astro.props;
const { language, textDirection } = I18N;

// Build Organization & WebSite schemas
const settings = getSiteSettings();

// Build sameAs array from social media links
const sameAs: string[] = [];
if (settings.seo.social?.linkedin) sameAs.push(settings.seo.social.linkedin);
if (settings.seo.social?.twitter) sameAs.push(settings.seo.social.twitter);
if (settings.seo.social?.facebook) sameAs.push(settings.seo.social.facebook);

// Build Organization schema
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': ['MedicalOrganization', 'LocalBusiness'],
  '@id': `${Astro.site}#organization`,
  name: settings.site.name,
  description: settings.seo.description,
  url: Astro.site?.href,
  email: settings.site.email,
  logo: {
    '@type': 'ImageObject',
    url: new URL(settings.logo.light, Astro.site).href,
  },
  medicalSpecialty: ['Psychiatry', 'Neurodevelopmental Disorders'],
  priceRange: '£££',

  // Conditional address (only if any address fields are provided)
  ...(settings.seo.business?.location &&
    (settings.seo.business.location.street_address ||
      settings.seo.business.location.address_locality ||
      settings.seo.business.location.address_region ||
      settings.seo.business.location.postal_code) && {
      address: {
        '@type': 'PostalAddress',
        ...(settings.seo.business.location.street_address && {
          streetAddress: settings.seo.business.location.street_address,
        }),
        ...(settings.seo.business.location.address_locality && {
          addressLocality: settings.seo.business.location.address_locality,
        }),
        ...(settings.seo.business.location.address_region && {
          addressRegion: settings.seo.business.location.address_region,
        }),
        ...(settings.seo.business.location.postal_code && {
          postalCode: settings.seo.business.location.postal_code,
        }),
        addressCountry: 'GB',
      },
    }),

  // Conditional geo coordinates (only if both lat and long are provided)
  ...(settings.seo.business?.location?.latitude &&
    settings.seo.business?.location?.longitude && {
      geo: {
        '@type': 'GeoCoordinates',
        latitude: settings.seo.business.location.latitude,
        longitude: settings.seo.business.location.longitude,
      },
    }),

  ...(settings.seo.area_served && {
    areaServed: {
      '@type': 'AdministrativeArea',
      name: settings.seo.area_served,
    },
  }),
  ...(sameAs.length > 0 && { sameAs }),
  ...(settings.seo.business?.founding_date && {
    foundingDate: settings.seo.business.founding_date,
  }),
  ...(settings.seo.business?.legal_name && {
    legalName: settings.seo.business.legal_name,
  }),
  ...(settings.seo.business?.vat_id && {
    vatID: settings.seo.business.vat_id,
  }),
};

// Build WebSite schema (NO SearchAction - Pagefind doesn't use URL-based search)
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: settings.site.name,
  url: Astro.site?.href,
};
---

<!doctype html>
<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Global Structured Data -->
    <StructuredData schema={organizationSchema} />
    <StructuredData schema={websiteSchema} />

    <!-- Comment the line below to disable View Transitions -->
    <ClientRouter fallback="swap" />
  </head>

  <body class="antialiased text-default bg-page tracking-tight">
    <slot />

    <BasicScripts />
  </body>
</html>
