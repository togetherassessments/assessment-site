---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import Features2 from '~/components/widgets/Features2.astro';
import Steps from '~/components/widgets/Steps.astro';
import BlogLatestPosts from '~/components/widgets/BlogLatestPosts.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Button from '~/components/ui/Button.astro';
import Image from '~/components/common/Image.astro';
import { Icon } from 'astro-icon/components';
import { getCollection, getEntry } from 'astro:content';
import { findImage } from '~/utils/images';
import { getSiteSettings } from '~/utils/site-settings';
import { generateHomePageSchema } from '~/utils/schema-generators';
import StructuredData from '~/components/common/StructuredData.astro';
import { marked } from 'marked';

// Load site settings and homepage content via content collections
const settings = getSiteSettings();
const homePageContent = await getEntry('home_page', 'content');

// Resolve logo images to ImageMetadata for proper optimization
const resolvedLogoLight = await findImage(settings.logo.light);
const resolvedLogoDark = await findImage(settings.logo.dark);

if (!homePageContent) {
  throw new Error('Home page content not found');
}

// Load content collections - filter for published items
const allServices = await getCollection('services_page_items');
const allFaqs = await getCollection('faqs_page_items');
const allTrustBadges = await getCollection('site_settings_trust_badges');

// Filter and sort
const services = allServices.filter((s) => s.data.published).sort((a, b) => a.data.order - b.data.order);
const faqs = allFaqs.filter((f) => f.data.published).sort((a, b) => a.data.order - b.data.order);
const trustBadges = allTrustBadges.filter((t) => t.data.published).sort((a, b) => a.data.order - b.data.order);

// Resolve badge images dynamically
const trustBadgesWithImages = await Promise.all(
  trustBadges.map(async (badge) => ({
    ...badge,
    resolvedLogoLight: await findImage(badge.data.logo_light),
    resolvedLogoDark: await findImage(badge.data.logo_dark),
  }))
);

// Get first 4 FAQs for homepage and process through markdown parser
const homepageFaqs = await Promise.all(
  faqs.slice(0, 4).map(async (faq) => ({
    title: faq.data.question,
    description: await marked.parse(faq.data.answer),
    icon: faq.data.icon,
  }))
);

// Build metadata with SEO field fallbacks
const metadata = {
  title: homePageContent.data.seo_settings?.metaTitle || settings.seo.title_default,
  ignoreTitleTemplate: true,
  description: homePageContent.data.seo_settings?.metaDescription || settings.seo.description,
  openGraph: {
    type: 'website',
    ...(settings.seo.og_image && {
      images: [{ url: settings.seo.og_image, width: 1200, height: 628 }],
    }),
  },
};

// HomePage schema - ensure title is always defined
const pageTitle = metadata.title || settings.site.name || 'Home';
const homePageSchema = generateHomePageSchema(Astro.url, pageTitle);

// Split site name for multicolor rendering
const siteNameWords = settings.site.name.split(' ');
---

<style>
  .site-name-multicolor span:nth-child(odd) {
    color: var(--aw-color-primary);
  }
  .site-name-multicolor span:nth-child(even) {
    color: var(--aw-color-accent);
  }
  .site-name-multicolor span {
    font-size: inherit !important;
    display: block;
  }
</style>

<Layout metadata={metadata}>
  <StructuredData schema={homePageSchema} />

  <!-- Site Logo -->
  <div class="text-center pt-6 pb-0 flex justify-center">
    <div class="h-24 w-auto">
      <Image
        src={resolvedLogoLight}
        alt={settings.logo.alt}
        class="h-full w-auto dark:hidden"
        layout="contained"
        loading="eager"
        fetchpriority="high"
      />
      <Image
        src={resolvedLogoDark}
        alt={settings.logo.alt}
        class="h-full w-auto hidden dark:block"
        layout="contained"
        loading="eager"
        fetchpriority="high"
      />
    </div>
  </div>

  <!-- Site Name -->
  <div class="text-center pt-0 pb-0">
    <h1 class="site-name-multicolor text-5xl md:text-6xl font-bold leading-tighter tracking-tighter mb-4 font-heading">
      {
        siteNameWords.map((word: string, index: number) => (
          <>
            <span>{word}</span>
            {index < siteNameWords.length - 1 ? ' ' : ''}
          </>
        ))
      }
    </h1>
  </div>

  <!-- Hero Widget -->
  <Hero
    noSpacer={true}
    tagline=""
    actions={[
      {
        variant: 'primary',
        text: settings.site.waitlist_only
          ? homePageContent.data.ctas.waitlist.text
          : homePageContent.data.ctas.consultation.text,
        href: settings.site.waitlist_only ? '/waitlist' : '/consultation',
        icon: 'tabler:calendar',
      },
    ]}
    image={{
      src: homePageContent.data.hero.image,
      alt: homePageContent.data.hero.image_alt || 'Hero image',
    }}
  >
    <Fragment slot="title">
      {homePageContent.data.hero.text}
    </Fragment>

    <Fragment slot="subtitle">
      <span class="font-semibold">{homePageContent.data.hero.title}</span>
      <br />
      <span class="text-muted">{homePageContent.data.hero.subtitle}</span>
    </Fragment>
  </Hero>

  <!-- Secondary CTA -->
  <div class="text-center py-8">
    <Button
      text={homePageContent.data.ctas.secondary.text}
      href={homePageContent.data.ctas.secondary.link}
      variant="secondary"
      class="w-auto"
    />
  </div>

  <!-- Trust Badges -->
  {
    trustBadgesWithImages.length > 0 && (
      <section class="py-12">
        <div class="max-w-6xl mx-auto px-4 sm:px-6">
          <div class="text-center mb-8">
            <p class="text-base text-muted dark:text-slate-400">{homePageContent.data.sections.trust_badges_heading}</p>
          </div>
          <div class="flex flex-col sm:flex-row sm:flex-wrap justify-center items-center gap-6 sm:gap-8 md:gap-12">
            {trustBadgesWithImages.map((badge) => (
              <div class="flex items-center gap-3 w-64 sm:w-auto">
                {badge.resolvedLogoLight && (
                  <Image
                    src={badge.resolvedLogoLight}
                    alt={badge.data.alt}
                    class="h-24 w-24 dark:hidden flex-shrink-0 object-contain"
                    width={95}
                    height={95}
                    layout="contained"
                  />
                )}
                {badge.resolvedLogoDark && (
                  <Image
                    src={badge.resolvedLogoDark}
                    alt={badge.data.alt}
                    class="h-24 w-24 hidden dark:block flex-shrink-0 object-contain"
                    width={95}
                    height={95}
                    layout="contained"
                  />
                )}
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300 text-center flex-1">
                  {badge.data.display_text}
                </span>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- How it Works -->
  <Steps
    title={homePageContent.data.sections.how_it_works}
    items={homePageContent.data.steps.map(
      (step: { title: string; text: string; icon: string; joined_to_previous: boolean }) => ({
        title: step.title,
        description: step.text,
        icon: step.icon,
        joined_to_previous: step.joined_to_previous,
      })
    )}
  />

  {/* Eventbrite Link - only shown when both text and URL are set */}
  {
    homePageContent.data.eventbrite?.text && homePageContent.data.eventbrite?.url && (
      <section class="py-12">
        <div class="max-w-3xl mx-auto px-4 text-center">
          {homePageContent.data.eventbrite.description && (
            <p class="text-lg text-muted dark:text-slate-400 mb-6">{homePageContent.data.eventbrite.description}</p>
          )}
          <a
            href={homePageContent.data.eventbrite.url}
            target="_blank"
            rel="noopener noreferrer"
            class="btn-primary inline-flex items-center justify-center gap-3 px-8 py-4 text-xl font-bold text-white bg-primary hover:bg-secondary hover:border-secondary dark:bg-primary dark:border-primary dark:hover:bg-secondary dark:hover:border-secondary rounded-full shadow-lg hover:shadow-xl dark:shadow-none transition-all duration-200"
          >
            <Icon name="tabler:calendar-event" class="w-6 h-6" />
            {homePageContent.data.eventbrite.text}
            <Icon name="tabler:external-link" class="w-5 h-5" />
          </a>
        </div>
      </section>
    )
  }

  <!-- Services -->
  <Features2
    title={homePageContent.data.sections.services}
    subtitle=""
    items={services.length > 0
      ? services.map((service) => ({
          title: service.data.title,
          description: service.data.description,
          icon: service.data.icon || 'tabler:point',
          callToAction: {
            text: `Learn more about ${service.data.title}`,
            href: `/services#${service.data.anchor}`,
          },
        }))
      : []}
  />

  <!-- Deep CTA -->
  <CallToAction
    title=""
    subtitle={homePageContent.data.ctas.deep.lead_text}
    actions={[
      {
        variant: 'primary',
        text: homePageContent.data.ctas.deep.text,
        href: homePageContent.data.ctas.deep.link,
        icon: 'tabler:message-circle',
      },
    ]}
  />

  <!-- Blog -->
  <BlogLatestPosts
    title={homePageContent.data.sections.blog}
    information={homePageContent.data.sections.blog_subtitle}
    count={4}
  />

  <!-- FAQs -->
  <FAQs title={homePageContent.data.sections.faqs} items={homepageFaqs} />

  <!-- More FAQs Button -->
  {
    faqs.length > 4 && (
      <div class="text-center py-4 mb-8">
        <Button
          text={homePageContent.data.sections.more_faqs_button_text}
          href="/faq"
          variant="secondary"
          class="w-auto"
        />
      </div>
    )
  }
</Layout>
