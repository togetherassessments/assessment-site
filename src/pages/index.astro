---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import Features2 from '~/components/widgets/Features2.astro';
import Steps from '~/components/widgets/Steps.astro';
import BlogLatestPosts from '~/components/widgets/BlogLatestPosts.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Button from '~/components/ui/Button.astro';
import Image from '~/components/common/Image.astro';
import { getCollection, getEntry } from 'astro:content';
import { findImage } from '~/utils/images';
import { getSiteSettings } from '~/utils/site-settings';

// Load site settings and homepage content via content collections
const settings = getSiteSettings();
const homePageContent = await getEntry('home_page', 'content');

if (!homePageContent) {
  throw new Error('Home page content not found');
}

// Load content collections - filter for published items
const allServices = await getCollection('services_page_items');
const allFaqs = await getCollection('faqs_page_items');
const allTrustBadges = await getCollection('site_settings_trust_badges');

// Filter and sort
const services = allServices.filter((s) => s.data.published).sort((a, b) => a.data.order - b.data.order);
const faqs = allFaqs.filter((f) => f.data.published).sort((a, b) => a.data.order - b.data.order);
const trustBadges = allTrustBadges.filter((t) => t.data.published).sort((a, b) => a.data.order - b.data.order);

// Resolve badge images dynamically
const trustBadgesWithImages = await Promise.all(
  trustBadges.map(async (badge) => ({
    ...badge,
    resolvedLogoLight: await findImage(badge.data.logo_light),
    resolvedLogoDark: await findImage(badge.data.logo_dark),
  }))
);

// Get first 4 FAQs for homepage
const homepageFaqs = faqs.slice(0, 4);

// Build metadata with SEO field fallbacks
const metadata = {
  title: homePageContent.data.seo_settings?.metaTitle || settings.seo.title_default,
  ignoreTitleTemplate: true,
  description: homePageContent.data.seo_settings?.metaDescription || settings.seo.description,
  openGraph: {
    type: 'website',
    ...(settings.seo.og_image && {
      images: [{ url: settings.seo.og_image, width: 1200, height: 628 }],
    }),
  },
};
---

<Layout metadata={metadata}>
  <!-- Site Name -->
  <div class="text-center pt-8 pb-0">
    <h1 class="text-5xl md:text-6xl font-bold leading-tighter tracking-tighter mb-4 font-heading">
      {settings.site.name}
    </h1>
  </div>

  <!-- Hero Widget -->
  <Hero
    noSpacer={true}
    tagline=""
    actions={[
      {
        variant: 'primary',
        text: settings.site.waitlist_only
          ? homePageContent.data.ctas.waitlist.text
          : homePageContent.data.ctas.consultation.text,
        href: settings.site.waitlist_only ? '/waitlist' : '/consultation',
        icon: 'tabler:calendar',
      },
    ]}
    image={{
      src: homePageContent.data.hero.image,
      alt: homePageContent.data.hero.image_alt || 'Hero image',
    }}
  >
    <Fragment slot="title">
      {homePageContent.data.hero.text}
    </Fragment>

    <Fragment slot="subtitle">
      <span class="font-semibold">{homePageContent.data.hero.title}</span>
      <br />
      <span class="text-muted">{homePageContent.data.hero.subtitle}</span>
    </Fragment>
  </Hero>

  <!-- Secondary CTA -->
  <div class="text-center py-8">
    <Button
      text={homePageContent.data.ctas.secondary.text}
      href={homePageContent.data.ctas.secondary.link}
      variant="secondary"
      class="w-auto"
    />
  </div>

  <!-- Trust Badges -->
  <section class="py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <div class="text-center mb-8">
        <p class="text-base text-muted dark:text-slate-400">Professional accreditations and memberships</p>
      </div>
      <div class="flex flex-col sm:flex-row sm:flex-wrap justify-center items-center gap-6 sm:gap-8 md:gap-12">
        {
          trustBadgesWithImages.map((badge) => (
            <div class="flex items-center gap-3 w-64 sm:w-auto">
              {badge.resolvedLogoLight && (
                <Image
                  src={badge.resolvedLogoLight}
                  alt={badge.data.alt}
                  class="h-12 w-auto dark:hidden flex-shrink-0"
                  width={48}
                  height={48}
                />
              )}
              {badge.resolvedLogoDark && (
                <Image
                  src={badge.resolvedLogoDark}
                  alt={badge.data.alt}
                  class="h-12 w-auto hidden dark:block flex-shrink-0"
                  width={48}
                  height={48}
                />
              )}
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300 text-center flex-1">
                {badge.data.display_text}
              </span>
            </div>
          ))
        }
      </div>
    </div>
  </section>

  <!-- How it Works -->
  <Steps
    title={homePageContent.data.sections.how_it_works}
    items={homePageContent.data.steps.map((step: { text: string }, index: number) => ({
      title: `Step ${index + 1}`,
      description: step.text,
      icon: index === 0 ? 'tabler:message-circle' : index === 1 ? 'tabler:clipboard-check' : 'tabler:bulb',
    }))}
  />

  <!-- Services -->
  <Features2
    title={homePageContent.data.sections.services}
    subtitle=""
    items={services.length > 0
      ? services.map((service) => ({
          title: service.data.title,
          description: service.data.description,
          icon: service.data.icon || 'tabler:point',
          callToAction: {
            text: `Learn more about ${service.data.title}`,
            href: `/services#${service.data.anchor}`,
          },
        }))
      : []}
  />

  <!-- Deep CTA -->
  <CallToAction
    title=""
    subtitle={homePageContent.data.ctas.deep.lead_text}
    actions={[
      {
        variant: 'primary',
        text: homePageContent.data.ctas.deep.text,
        href: homePageContent.data.ctas.deep.link,
        icon: 'tabler:message-circle',
      },
    ]}
  />

  <!-- Blog -->
  <BlogLatestPosts
    title={homePageContent.data.sections.blog}
    information={homePageContent.data.sections.blog_subtitle}
    count={4}
  />

  <!-- FAQs -->
  <FAQs
    title={homePageContent.data.sections.faqs}
    items={homepageFaqs.length > 0
      ? homepageFaqs.map((faq) => ({
          title: faq.data.question,
          description: faq.data.answer,
        }))
      : []}
  />

  <!-- More FAQs Button -->
  {
    faqs.length > 4 && (
      <div class="text-center py-4 mb-8">
        <Button text="More FAQs" href="/faq" variant="secondary" class="w-auto" />
      </div>
    )
  }
</Layout>
